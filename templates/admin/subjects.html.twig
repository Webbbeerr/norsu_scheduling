{% extends 'admin/base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <!-- DataTables CSS - Local -->
    <link rel="stylesheet" href="{{ asset('vendor/css/jquery.dataTables.min.css') }}">
    <style>
        /* Custom DataTables styling to match your theme */
        .dataTables_wrapper .dataTables_length select {
            padding: 0.375rem 2rem 0.375rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }

        .dataTables_wrapper .dataTables_filter input {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-left: 0.5rem;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 0.375rem 0.75rem;
            margin: 0 0.125rem;
            border-radius: 0.375rem;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #2563eb;
            color: white !important;
            border-color: #2563eb;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #3b82f6;
            color: white !important;
            border-color: #3b82f6;
        }

        table.dataTable thead th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
    </style>
{% endblock %}

{% block main_content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl shadow-lg p-8 mb-8">
        <div class="flex justify-between items-center">
            <div class="flex-1">
                <h1 class="text-3xl font-bold text-white mb-2">Subject Management</h1>
                <p class="text-blue-100">Manage all subjects and courses in the system</p>
            </div>
            <a href="{{ path('admin_subjects_create') }}" class="bg-white text-blue-600 px-6 py-3 rounded-lg font-medium hover:bg-blue-50 transition duration-150 shadow-md flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Add New Subject
            </a>
        </div>
    </div>

    <!-- Info Banner for Published Curricula Filter -->
    {% if filters.published_only == '1' %}
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-lg">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    <strong>Filtered View:</strong> Showing only subjects from <strong>published curricula</strong>. 
                    Subjects in draft/unpublished curricula are hidden. To view all subjects, change the "Curriculum Status" filter to "Show All Subjects".
                </p>
            </div>
        </div>
    </div>
    {% elseif filters.published_only == '0' %}
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded-lg">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-blue-700">
                    <strong>Default View:</strong> Showing <strong>ALL subjects</strong> regardless of curriculum publication status. 
                    This includes subjects from both published and draft curricula.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Semester Filter Notice -->
    {% if semesterFilter %}
    <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-l-4 border-purple-500 p-5 mb-6 rounded-lg shadow-sm">
        <div class="flex items-start justify-between">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-purple-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-base font-bold text-purple-900 mb-1">
                        ðŸŽ¯ Semester Filter Active: {{ semesterFilter }} Semester
                    </h3>
                    <p class="text-sm text-purple-700">
                        Showing only subjects from <strong>{{ semesterFilter }} Semester</strong> across all curricula.
                    </p>
                </div>
            </div>
            <form action="{{ path('admin_subjects_clear_semester_filter') }}" method="POST" class="ml-4">
                <button type="submit"
                        onclick="return confirm('Clear semester filter and show all subjects?')"
                        class="inline-flex items-center px-4 py-2 bg-white text-purple-700 border-2 border-purple-300 rounded-lg font-medium hover:bg-purple-50 transition duration-150 shadow-sm text-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Clear Filter
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 mb-1">Total Subjects</p>
                    <p class="text-3xl font-bold text-gray-900">{{ statistics.total }}</p>
                </div>
                <div class="bg-blue-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 mb-1">Active Subjects</p>
                    <p class="text-3xl font-bold text-gray-900">{{ statistics.active }}</p>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 mb-1">Inactive Subjects</p>
                    <p class="text-3xl font-bold text-gray-900">{{ statistics.inactive }}</p>
                </div>
                <div class="bg-red-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 mb-1">Departments</p>
                    <p class="text-3xl font-bold text-gray-900">{{ departments|length }}</p>
                </div>
                <div class="bg-purple-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <!-- Search -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                <input type="text" id="searchFilter" placeholder="Search by code or title..." 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Department Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                <select id="departmentFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                        <option value="{{ dept.name }} ({{ dept.code }})">
                            {{ dept.name }} ({{ dept.code }})
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Type Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                <select id="typeFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Types</option>
                    <option value="Lecture">Lecture</option>
                    <option value="Laboratory">Laboratory</option>
                    <option value="Lecture & Lab">Lecture & Lab</option>
                </select>
            </div>

            <!-- Status Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Status</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                </select>
            </div>

            <!-- Curriculum Status Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Curriculum Status</label>
                <select id="curriculumStatusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="all" {% if filters.published_only == '0' %}selected{% endif %}>Show All Subjects (Default)</option>
                    <option value="published" {% if filters.published_only == '1' %}selected{% endif %}>Published Curricula Only</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Subjects Table -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table id="subjectsTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Units</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hours</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% if subjects|length > 0 %}
                        {% for subject in subjects %}
                        <tr class="hover:bg-gray-50 transition duration-150">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="font-semibold text-blue-600">{{ subject.code }}</span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900">{{ subject.title }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% set department = null %}
                                {% for dept in departments %}
                                    {% if dept.id == subject.departmentId %}
                                        {% set department = dept %}
                                    {% endif %}
                                {% endfor %}
                                <span class="text-sm text-gray-600">{{ department ? department.name ~ ' (' ~ department.code ~ ')' : 'N/A' }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900">{{ subject.units }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-600">
                                    L: {{ subject.lectureHours ?? 0 }} / Lab: {{ subject.labHours ?? 0 }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {{ subject.typeBadge|raw }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {{ subject.statusBadge|raw }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex items-center gap-2">
                                    <a href="{{ path('admin_subjects_view', {id: subject.id}) }}" 
                                       class="text-indigo-600 hover:text-indigo-900 inline-flex items-center justify-center w-8 h-8 rounded-lg hover:bg-indigo-50 transition" 
                                       title="View">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                        </svg>
                                    </a>
                                    <a href="{{ path('admin_subjects_edit', {id: subject.id}) }}" 
                                       class="text-gray-600 hover:text-gray-900 inline-flex items-center justify-center w-8 h-8 rounded-lg hover:bg-gray-100 transition" 
                                       title="Edit">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </a>
                                    <form method="post" action="{{ path('admin_subjects_delete', {id: subject.id}) }}" 
                                          onsubmit="return confirm('Are you sure you want to delete this subject?');" class="inline m-0">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete_subject_' ~ subject.id) }}">
                                        <button type="submit" 
                                                class="text-red-600 hover:text-red-900 inline-flex items-center justify-center w-8 h-8 rounded-lg hover:bg-red-50 transition" 
                                                title="Delete">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr class="no-data-row">
                            <td colspan="8" class="px-6 py-12 text-center">
                                <div class="text-gray-500">
                                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                    </svg>
                                    <p class="text-lg font-medium mb-2">No subjects found</p>
                                    <p class="text-sm">Try adjusting your filters or create a new subject.</p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<!-- jQuery (required for DataTables) - Local -->
<script src="{{ asset('vendor/js/jquery.min.js') }}"></script>
<!-- DataTables JS - Local -->
<script src="{{ asset('vendor/js/jquery.dataTables.min.js') }}"></script>

<script>
$(document).ready(function() {
    // Check if table has actual data rows (not the "no subjects" message row)
    const hasNoDataRow = $('#subjectsTable tbody tr.no-data-row').length > 0;
    
    if (hasNoDataRow) {
        console.log('No subjects to display - DataTables not initialized');
        return;
    }
    
    // Check if DataTable already exists and destroy it
    if ($.fn.DataTable.isDataTable('#subjectsTable')) {
        $('#subjectsTable').DataTable().destroy();
    }
    
    // Initialize DataTables
    const table = $('#subjectsTable').DataTable({
        paging: true,
        pageLength: -1, // Show all subjects by default
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        info: true,
        searching: true,
        ordering: true,
        order: [[0, 'asc']], // Sort by Code by default
        columnDefs: [
            { orderable: true, targets: 0 }, // Code
            { orderable: true, targets: 1 }, // Title
            { orderable: true, targets: 2 }, // Department
            { orderable: true, targets: 3 }, // Units
            { orderable: false, targets: 4 }, // Hours
            { orderable: true, targets: 5 }, // Type
            { orderable: true, targets: 6 }, // Status
            { orderable: false, targets: 7 }  // Actions
        ],
        language: {
            search: "Search subjects:",
            lengthMenu: "Show _MENU_ subjects per page",
            info: "Showing _START_ to _END_ of _TOTAL_ subjects",
            infoEmpty: "No subjects available",
            infoFiltered: "(filtered from _MAX_ total subjects)",
            zeroRecords: "No matching subjects found",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        },
        // Hide the built-in search, length controls, info text, and pagination
        dom: 'rt'
    });

    // Custom search filter
    $('#searchFilter').on('keyup', function() {
        table.search(this.value).draw();
    });

    // Department filter
    $('#departmentFilter').on('change', function() {
        table.column(2).search(this.value).draw();
    });

    // Type filter
    $('#typeFilter').on('change', function() {
        table.column(5).search(this.value).draw();
    });

    // Status filter
    $('#statusFilter').on('change', function() {
        table.column(6).search(this.value).draw();
    });

    // Curriculum Status filter - reload page with query parameter
    $('#curriculumStatusFilter').on('change', function() {
        const publishedOnly = this.value === 'published' ? '1' : '0';
        window.location.href = '{{ path('admin_subjects') }}?published_only=' + publishedOnly;
    });

    // Optional: Add custom styling to the search input
    $('.dataTables_filter input').addClass('px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500');
    $('.dataTables_length select').addClass('px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500');

    // Prevent Enter key from submitting forms (global handler for all inputs except submit buttons)
    $('body').on('keypress', 'input:not([type="submit"])', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}
