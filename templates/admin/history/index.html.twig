{% extends 'admin/base.html.twig' %}

{% block title %}History & Reports{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        /* ============================================
           MODERN DATATABLE UI - COMPLETE STYLING
           ============================================ */
        
        /* === 1. TABLE STRUCTURE === */
        table.dataTable {
            width: 100% !important;
            border-collapse: separate !important;
            border-spacing: 0 !important;
            background: white !important;
            border-radius: 0.5rem !important;
        }

        /* === 2. TABLE HEADER === */
        table.dataTable thead th {
            background: linear-gradient(to bottom, #f9fafb, #f3f4f6) !important;
            color: #374151 !important;
            font-weight: 600 !important;
            font-size: 0.75rem !important;
            text-transform: uppercase !important;
            letter-spacing: 0.05em !important;
            padding: 1rem !important;
            border-bottom: 2px solid #e5e7eb !important;
            white-space: nowrap !important;
        }

        /* Sorting indicators */
        table.dataTable thead th.sorting,
        table.dataTable thead th.sorting_asc,
        table.dataTable thead th.sorting_desc { 
            cursor: pointer !important;
            position: relative !important;
            padding-right: 30px !important;
        }

        table.dataTable thead th.sorting:before,
        table.dataTable thead th.sorting:after,
        table.dataTable thead th.sorting_asc:before,
        table.dataTable thead th.sorting_asc:after,
        table.dataTable thead th.sorting_desc:before,
        table.dataTable thead th.sorting_desc:after {
            opacity: 0.3 !important;
            font-size: 0.7rem !important;
        }

        table.dataTable thead th.sorting_asc:after {
            opacity: 1 !important;
            color: #3b82f6 !important;
        }

        table.dataTable thead th.sorting_desc:before {
            opacity: 1 !important;
            color: #3b82f6 !important;
        }

        /* === 3. TABLE BODY === */
        table.dataTable tbody tr {
            transition: all 0.15s ease !important;
        }

        table.dataTable tbody tr:hover {
            background-color: #f9fafb !important;
        }

        table.dataTable tbody tr.odd {
            background-color: white !important;
        }

        table.dataTable tbody tr.even {
            background-color: #fafbfc !important;
        }

        table.dataTable tbody td {
            padding: 1rem !important;
            border-bottom: 1px solid #f3f4f6 !important;
            color: #374151 !important;
            font-size: 0.875rem !important;
        }

        /* === 4. WRAPPER CONTROLS === */
        .dataTables_wrapper {
            padding: 1.5rem !important;
            background: white !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
        }

        /* === 5. LENGTH SELECTOR (Show X entries) === */
        .dataTables_wrapper .dataTables_length {
            float: left !important;
            margin-bottom: 1.5rem !important;
        }

        .dataTables_wrapper .dataTables_length label {
            display: inline-flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
            font-size: 0.875rem !important;
            color: #6b7280 !important;
            font-weight: 500 !important;
        }

        .dataTables_wrapper .dataTables_length select {
            padding: 0.5rem 2.5rem 0.5rem 0.75rem !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            background-color: white !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important;
            background-position: right 0.5rem center !important;
            background-repeat: no-repeat !important;
            background-size: 1.5em 1.5em !important;
            font-size: 0.875rem !important;
            color: #374151 !important;
            cursor: pointer !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
        }

        .dataTables_wrapper .dataTables_length select:focus {
            outline: none !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }

        /* === 6. SEARCH BOX === */
        .dataTables_wrapper .dataTables_filter {
            display: none !important; /* Hide default search - we have custom filters */
        }

        /* === 7. INFO TEXT (Showing X to Y of Z entries) === */
        div.dataTables_wrapper div.dataTables_info {
            float: left !important;
            padding-top: 1.25rem !important;
            padding-bottom: 1rem !important;
            font-size: 0.875rem !important;
            color: #6b7280 !important;
            font-weight: 500 !important;
            clear: none !important;
        }

        /* === 8. PAGINATION CONTAINER === */
        div.dataTables_wrapper div.dataTables_paginate {
            float: right !important;
            text-align: right !important;
            padding-top: 1rem !important;
            padding-bottom: 1rem !important;
            margin: 0 !important;
            display: flex !important;
            align-items: center !important;
            gap: 0.75rem !important;
        }

        div.dataTables_wrapper div.dataTables_paginate span {
            display: inline-flex !important;
            gap: 0.5rem !important;
            align-items: center !important;
        }

        /* === 9. PAGINATION BUTTONS === */
        div.dataTables_wrapper div.dataTables_paginate .paginate_button,
        div.dataTables_wrapper div.dataTables_paginate .paginate_button:link,
        div.dataTables_wrapper div.dataTables_paginate .paginate_button:visited {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-sizing: border-box !important;
            min-width: 2.5rem !important;
            height: 2.5rem !important;
            padding: 0.5rem 0.875rem !important;
            margin: 0 0.25rem !important;
            border-radius: 0.5rem !important;
            border: 1px solid #d1d5db !important;
            background: white !important;
            background-color: white !important;
            background-image: none !important;
            color: #4b5563 !important;
            cursor: pointer !important;
            text-decoration: none !important;
            font-size: 0.875rem !important;
            font-weight: 500 !important;
            line-height: 1.25rem !important;
            text-align: center !important;
            transition: all 0.2s ease-in-out !important;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
            vertical-align: middle !important;
            white-space: nowrap !important;
        }

        /* Current/Active Page - Blue Background */
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.current,
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.current:hover,
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.current:link,
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.current:visited {
            background: #3b82f6 !important;
            background-color: #3b82f6 !important;
            background-image: none !important;
            color: white !important;
            border-color: #3b82f6 !important;
            font-weight: 600 !important;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4), 0 2px 4px -1px rgba(59, 130, 246, 0.3) !important;
            cursor: default !important;
        }

        /* Hover State - Light Gray with Blue Border */
        div.dataTables_wrapper div.dataTables_paginate .paginate_button:hover:not(.disabled):not(.current) {
            background: #f3f4f6 !important;
            background-color: #f3f4f6 !important;
            background-image: none !important;
            border-color: #3b82f6 !important;
            color: #3b82f6 !important;
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1) !important;
            transform: translateY(-1px) !important;
        }

        /* Disabled State - Grayed Out and Non-Interactive */
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.disabled,
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.disabled:hover,
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.disabled:active,
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.disabled:link,
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.disabled:visited {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
            color: #9ca3af !important;
            background: #f9fafb !important;
            background-color: #f9fafb !important;
            background-image: none !important;
            border-color: #e5e7eb !important;
            box-shadow: none !important;
            transform: none !important;
        }

        /* Previous/Next Buttons - Distinctive Styling with More Padding */
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.previous,
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.next,
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.first,
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.last {
            font-weight: 600 !important;
            padding: 0.5rem 1rem !important;
            min-width: auto !important;
            margin: 0 0.375rem !important;
            border-color: #d1d5db !important;
            background: #ffffff !important;
        }

        /* First and Last get extra margin for separation */
        div.dataTables_wrapper div.dataTables_paginate .paginate_button.first {
            margin-right: 0.75rem !important;
        }

        div.dataTables_wrapper div.dataTables_paginate .paginate_button.last {
            margin-left: 0.75rem !important;
        }

        /* Ellipsis - Clear Visual Separator */
        div.dataTables_wrapper div.dataTables_paginate .ellipsis {
            display: inline-flex !important;
            align-items: center !important;
            padding: 0.5rem 0.25rem !important;
            color: #9ca3af !important;
            margin: 0 0.25rem !important;
            font-weight: 500 !important;
        }

        /* === 10. CLEAR FLOATS === */
        .dataTables_wrapper:before,
        .dataTables_wrapper:after {
            content: "" !important;
            display: table !important;
            clear: both !important;
        }

        /* === 11. RESPONSIVE === */
        @media (max-width: 768px) {
            .dataTables_wrapper .dataTables_length,
            .dataTables_wrapper .dataTables_filter {
                float: none !important;
                text-align: left !important;
                margin-bottom: 1rem !important;
            }

            .dataTables_wrapper .dataTables_info,
            .dataTables_wrapper .dataTables_paginate {
                float: none !important;
                text-align: center !important;
                margin-top: 1rem !important;
            }

            div.dataTables_wrapper div.dataTables_paginate {
                justify-content: center !important;
            }
        }

        /* === 12. PROCESSING INDICATOR === */
        .dataTables_processing {
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            background: white !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 0.5rem !important;
            padding: 1rem 2rem !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
            color: #3b82f6 !important;
            font-weight: 500 !important;
        }
    </style>
{% endblock %}

{% block main_content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 flex items-center">
            <svg class="h-8 w-8 text-teal-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            History & Reports
        </h1>
        <p class="mt-2 text-gray-600">View and export historical data for rooms and faculty teaching loads across all semesters</p>
    </div>

    {% if hasActiveSemester %}
    <div class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-center">
            <svg class="h-5 w-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
            <span class="text-blue-800 font-medium">Current Active Semester: {{ activeYear }} | {{ activeSemester }}</span>
        </div>
    </div>
    {% endif %}

    {# Universal Filters #}
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="h-5 w-5 text-gray-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                </svg>
                Filter Historical Data
            </h2>
            <span class="text-sm text-gray-500" id="filterStatus">
                {% if selectedDepartment or selectedYear or selectedSemester or searchTerm %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-teal-100 text-teal-800">
                        Filtered: 
                        {% if selectedDepartment %}
                            {% for dept in departments %}
                                {% if (dept.id ~ '') == selectedDepartment %}{{ dept.name }}{% endif %}
                            {% endfor %}{% if selectedYear or selectedSemester %} | {% endif %}
                        {% endif %}
                        {{ selectedYear ?: 'All Years' }}{% if selectedSemester %} | {{ selectedSemester }}{% endif %}
                        {% if searchTerm %} | Search: "{{ searchTerm }}"{% endif %}
                    </span>
                {% else %}
                    <span class="text-gray-400">Showing all historical data</span>
                {% endif %}
            </span>
        </div>
        
        <div id="filterForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                {# Department Filter #}
                <div>
                    <label for="filterDepartment" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                    <select name="department" id="filterDepartment" class="filter-select w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}" {% if selectedDepartment and (dept.id ~ '') == selectedDepartment %}selected{% endif %}>{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                {# Academic Year Filter #}
                <div>
                    <label for="filterYear" class="block text-sm font-medium text-gray-700 mb-1">Academic Year</label>
                    <select name="year" id="filterYear" class="filter-select w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <option value="">All Years</option>
                        {% for year in years %}
                        <option value="{{ year }}" {% if selectedYear == year %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>

                {# Semester Filter #}
                <div>
                    <label for="filterSemester" class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                    <select name="semester" id="filterSemester" class="filter-select w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <option value="">All Semesters</option>
                        <option value="1st" {% if selectedSemester == '1st' %}selected{% endif %}>1st Semester</option>
                        <option value="2nd" {% if selectedSemester == '2nd' %}selected{% endif %}>2nd Semester</option>
                        <option value="Summer" {% if selectedSemester == 'Summer' %}selected{% endif %}>Summer</option>
                    </select>
                </div>

                {# Search Box #}
                <div>
                    <label for="filterSearch" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                    <input type="text" name="search" id="filterSearch" value="{{ searchTerm }}" placeholder="Room name, faculty name..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" id="clearFilters" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition">
                    <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Clear
                </button>
            </div>
        </div>
    </div>

    {# Tabs Navigation #}
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex" aria-label="Tabs">
                <button onclick="showTab('rooms')" id="tab-rooms" class="tab-button w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm transition-colors">
                    <svg class="inline-block h-5 w-5 mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    Room History ({{ roomsData|length }})
                </button>
                <button onclick="showTab('faculty')" id="tab-faculty" class="tab-button w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm transition-colors">
                    <svg class="inline-block h-5 w-5 mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    Faculty History ({{ facultyData|length }})
                </button>
            </nav>
        </div>

        {# Room History Tab #}
        <div id="content-rooms" class="tab-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Room Usage History</h2>
                    {# Debug: {{ roomsData|length }} rooms found #}
                    {% if roomsData|length > 0 %}
                    <a href="{{ path('admin_history') ~ '?export=rooms' ~ (selectedDepartment ? '&department=' ~ selectedDepartment : '') ~ (selectedYear ? '&year=' ~ selectedYear : '') ~ (selectedSemester ? '&semester=' ~ selectedSemester : '') ~ (searchTerm ? '&search=' ~ searchTerm : '') }}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">
                        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Export All Rooms (CSV)
                    </a>
                    {% endif %}
                </div>

                {% if roomsData|length == 0 %}
                <div class="text-center py-12 bg-gray-50 rounded-lg">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No rooms found</h3>
                    <p class="mt-1 text-sm text-gray-500">Try adjusting your filters</p>
                </div>
                {% else %}
                <div class="overflow-x-auto">
                    <table id="roomsTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Room</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Building</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Capacity</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Schedule Count</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for item in roomsData %}
                            {% set room = item[0] %}
                            {% set scheduleCount = item.scheduleCount %}
                            {% set departments = item.departments|default('') %}
                            {% set years = item.years|default('') %}
                            {% set semesters = item.semesters|default('') %}
                            <tr class="hover:bg-gray-50" data-departments="{{ departments }}" data-years="{{ years }}" data-semesters="{{ semesters }}" data-room-name="{{ room.name }}">
                                {# DEBUG: Room {{ room.name }} - Depts: {{ departments }} | Years: {{ years }} | Sems: {{ semesters }} #}
                                <td class="px-6 py-4">
                                    <div class="text-sm font-medium">{{ room.name }}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900">{{ room.building }}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900">{{ room.capacity }}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                        {{ scheduleCount }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-right text-sm font-medium">
                                    <a href="{{ path('admin_rooms_history', {id: room.id}) }}" class="text-teal-600 hover:text-teal-900 mr-3">
                                        View Details
                                    </a>
                                    <a href="{{ path('admin_rooms_history_export', {id: room.id}) }}" class="text-green-600 hover:text-green-900">
                                        Export
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>

        {# Faculty History Tab #}
        <div id="content-faculty" class="tab-content hidden">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Faculty Teaching History</h2>
                    {# Debug: {{ facultyData|length }} faculty found #}
                    {% if facultyData|length > 0 %}
                    <a href="{{ path('admin_history') ~ '?export=faculty' ~ (selectedDepartment ? '&department=' ~ selectedDepartment : '') ~ (selectedYear ? '&year=' ~ selectedYear : '') ~ (selectedSemester ? '&semester=' ~ selectedSemester : '') ~ (searchTerm ? '&search=' ~ searchTerm : '') }}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">
                        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Export All Faculty (CSV)
                    </a>
                    {% endif %}
                </div>

                {% if facultyData|length == 0 %}
                <div class="text-center py-12 bg-gray-50 rounded-lg">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No faculty found</h3>
                    <p class="mt-1 text-sm text-gray-500">Try adjusting your filters</p>
                </div>
                {% else %}
                <div class="overflow-x-auto">
                    <table id="facultyTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Faculty Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teaching Load</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for item in facultyData %}
                            {% set faculty = item[0] %}
                            {% set scheduleCount = item.scheduleCount %}
                            {% set totalUnits = item.totalUnits ?? 0 %}
                            {% set departments = item.departments|default('') %}
                            {% set years = item.years|default('') %}
                            {% set semesters = item.semesters|default('') %}
                            <tr class="hover:bg-gray-50" data-departments="{{ departments }}" data-years="{{ years }}" data-semesters="{{ semesters }}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <div class="h-10 w-10 rounded-full bg-purple-100 flex items-center justify-center">
                                                <span class="text-purple-700 font-medium text-sm">{{ faculty.firstName|first }}{{ faculty.lastName|first }}</span>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">{{ faculty.firstName }} {{ faculty.lastName }}</div>
                                            <div class="text-sm text-gray-500">{{ faculty.position }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">{{ faculty.employeeId }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">
                                        {% if faculty.department %}
                                            {{ faculty.department.name }}
                                        {% else %}
                                            <span class="text-gray-400">No Department</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                            {{ totalUnits }} units
                                        </span>
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800 ml-1">
                                            {{ scheduleCount }} subjects
                                        </span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <a href="{{ path('admin_users_faculty_history', {id: faculty.id}) }}" class="text-teal-600 hover:text-teal-900 mr-3">
                                        View Details
                                    </a>
                                    <a href="{{ path('admin_users_faculty_history_export', {id: faculty.id}) }}" class="text-green-600 hover:text-green-900">
                                        Export
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<!-- jQuery (required for DataTables) - Local -->
<script src="{{ asset('vendor/js/jquery.min.js') }}"></script>
<!-- DataTables JS - Local -->
<script src="{{ asset('vendor/js/jquery.dataTables.min.js') }}"></script>

<script>
let roomsTable, facultyTable;

// Tab switching
function showTab(tab) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active state from all tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('border-teal-500', 'text-teal-600');
        button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    });
    
    // Show selected tab content
    document.getElementById('content-' + tab).classList.remove('hidden');
    
    // Add active state to selected tab button
    const activeButton = document.getElementById('tab-' + tab);
    activeButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    activeButton.classList.add('border-teal-500', 'text-teal-600');
    
    // Store active tab in localStorage
    localStorage.setItem('activeHistoryTab', tab);
    
    // Reapply filters when switching tabs (redraw both tables to ensure filters work)
    if (roomsTable) roomsTable.draw();
    if (facultyTable) facultyTable.draw();
}

// Initialize Rooms DataTable
function initRoomsTable() {
    if ($.fn.DataTable.isDataTable('#roomsTable')) {
        roomsTable = $('#roomsTable').DataTable();
        return roomsTable;
    }
    
    {% if roomsData|length > 0 %}
    roomsTable = $('#roomsTable').DataTable({
        paging: false,
        info: false,
        lengthChange: false,
        searching: true,  // MUST be true for custom search to work
        ordering: true,
        order: [[0, 'asc']], // Sort by Room name by default
        columnDefs: [
            { orderable: true, targets: 0 },  // Room
            { orderable: true, targets: 1 },  // Building
            { orderable: true, targets: 2 },  // Capacity
            { orderable: true, targets: 3 },  // Schedule Count
            { orderable: false, targets: 4 }  // Actions
        ]
    });
    return roomsTable;
    {% endif %}
}

// Initialize Faculty DataTable
function initFacultyTable() {
    if ($.fn.DataTable.isDataTable('#facultyTable')) {
        facultyTable = $('#facultyTable').DataTable();
        return facultyTable;
    }
    
    {% if facultyData|length > 0 %}
    facultyTable = $('#facultyTable').DataTable({
        paging: false,
        info: false,
        lengthChange: false,
        searching: true,  // MUST be true for custom search to work
        ordering: true,
        order: [[0, 'asc']], // Sort by Faculty name by default
        columnDefs: [
            { orderable: true, targets: 0 },  // Faculty Name
            { orderable: true, targets: 1 },  // Employee ID
            { orderable: true, targets: 2 },  // Department
            { orderable: true, targets: 3 },  // Teaching Load
            { orderable: false, targets: 4 }  // Actions
        ]
    });
    return facultyTable;
    {% endif %}
}

// Apply Tailwind classes to DataTables pagination
function applyTailwindToPagination(table) {
    const wrapper = $(table.table().container());
    
    // Style the pagination container
    const paginate = wrapper.find('.dataTables_paginate');
    paginate.css({
        'display': 'flex',
        'align-items': 'center',
        'gap': '0.75rem',
        'justify-content': 'flex-end',
        'padding-top': '1rem'
    });
    
    // Style the page number container span
    paginate.find('span').css({
        'display': 'inline-flex',
        'gap': '0.5rem',
        'align-items': 'center'
    });
    
    // Style all pagination buttons
    wrapper.find('.paginate_button').each(function() {
        const $btn = $(this);
        
        // Check state BEFORE removing classes
        const isCurrent = $btn.hasClass('current');
        const isDisabled = $btn.hasClass('disabled');
        const isPrevious = $btn.hasClass('previous');
        const isNext = $btn.hasClass('next');
        const isFirst = $btn.hasClass('first');
        const isLast = $btn.hasClass('last');
        
        // Apply inline styles for immediate effect
        const baseStyles = {
            'display': 'inline-flex',
            'align-items': 'center',
            'justify-content': 'center',
            'min-width': '2.5rem',
            'height': '2.5rem',
            'padding': '0.5rem 0.875rem',
            'margin': '0 0.125rem',
            'border-radius': '0.5rem',
            'border': '1px solid',
            'font-size': '0.875rem',
            'font-weight': '500',
            'text-align': 'center',
            'transition': 'all 0.2s ease',
            'text-decoration': 'none',
            'white-space': 'nowrap'
        };
        
        if (isCurrent) {
            // Active page - blue background
            Object.assign(baseStyles, {
                'background-color': '#3b82f6',
                'color': '#ffffff',
                'border-color': '#3b82f6',
                'font-weight': '600',
                'cursor': 'default',
                'box-shadow': '0 4px 6px -1px rgba(59, 130, 246, 0.4)'
            });
        } else if (isDisabled) {
            // Disabled - grayed out
            Object.assign(baseStyles, {
                'background-color': '#f9fafb',
                'color': '#9ca3af',
                'border-color': '#e5e7eb',
                'opacity': '0.5',
                'cursor': 'not-allowed',
                'pointer-events': 'none'
            });
        } else if (isPrevious || isNext || isFirst || isLast) {
            // Previous/Next/First/Last buttons
            Object.assign(baseStyles, {
                'background-color': '#ffffff',
                'color': '#374151',
                'border-color': '#d1d5db',
                'font-weight': '600',
                'padding': '0.5rem 1rem',
                'cursor': 'pointer',
                'box-shadow': '0 1px 2px 0 rgba(0, 0, 0, 0.05)'
            });
        } else {
            // Regular page numbers
            Object.assign(baseStyles, {
                'background-color': '#ffffff',
                'color': '#374151',
                'border-color': '#d1d5db',
                'cursor': 'pointer',
                'box-shadow': '0 1px 2px 0 rgba(0, 0, 0, 0.05)'
            });
        }
        
        $btn.css(baseStyles);
        
        // Add hover effects for non-disabled, non-current buttons
        if (!isCurrent && !isDisabled) {
            $btn.hover(
                function() {
                    $(this).css({
                        'background-color': '#f3f4f6',
                        'border-color': '#3b82f6',
                        'color': '#3b82f6',
                        'box-shadow': '0 2px 4px 0 rgba(0, 0, 0, 0.1)'
                    });
                },
                function() {
                    $(this).css({
                        'background-color': '#ffffff',
                        'border-color': '#d1d5db',
                        'color': '#374151',
                        'box-shadow': '0 1px 2px 0 rgba(0, 0, 0, 0.05)'
                    });
                }
            );
        }
    });
    
    // Style the info text
    wrapper.find('.dataTables_info').css({
        'font-size': '0.875rem',
        'color': '#6b7280',
        'font-weight': '500',
        'padding-top': '1rem'
    });
}

// Pure client-side filtering (NO page reloads - like rooms page)
let currentFilters = {
    department: '',
    year: '',
    semester: '',
    search: ''
};

// Custom search function for DataTables filtering
$.fn.dataTable.ext.search.push(
    function(settings, data, dataIndex) {
        // Determine which table this is by checking the table ID
        const tableId = settings.nTable.id;
        const isRoomsTable = tableId === 'roomsTable';
        const isFacultyTable = tableId === 'facultyTable';
        
        // Get the table instance
        const table = $.fn.dataTable.Api(settings);
        const row = table.row(dataIndex).node();
        if (!row) return true;
        
        console.log(`Filtering ${tableId}, row ${dataIndex}`);
        
        // Apply search filter across all columns
        if (currentFilters.search) {
            const searchLower = currentFilters.search.toLowerCase();
            const rowText = data.join(' ').toLowerCase();
            if (!rowText.includes(searchLower)) {
                return false;
            }
        }
        
        // For rooms tab, filter by department/year/semester using data attributes
        if (isRoomsTable) {
            const rowDepts = $(row).attr('data-departments') || '';
            const rowYears = $(row).attr('data-years') || '';
            const rowSemesters = $(row).attr('data-semesters') || '';
            const roomName = $(row).attr('data-room-name') || '';
            
            if (currentFilters.department) {
                const deptName = $('#filterDepartment option:selected').text().trim();
                console.log(`Room ${roomName} - Checking dept: "${deptName}" in "${rowDepts}"`);
                // Filter out if: no departments OR department not in list
                if (!rowDepts || !rowDepts.includes(deptName)) {
                    console.log(`  → FILTERED OUT (dept)`);
                    return false;
                }
            }
            
            if (currentFilters.year) {
                console.log(`Room ${roomName} - Checking year: "${currentFilters.year}" in "${rowYears}"`);
                // Filter out if: no years OR year not in list
                if (!rowYears || !rowYears.includes(currentFilters.year)) {
                    console.log(`  → FILTERED OUT (year)`);
                    return false;
                }
            }
            
            if (currentFilters.semester) {
                const semesterValue = currentFilters.semester; // Use value not text ("1st", "2nd", "Summer")
                console.log(`Room ${roomName} - Checking semester: "${semesterValue}" in "${rowSemesters}"`);
                // Filter out if: no semesters OR semester not in list
                if (!rowSemesters || !rowSemesters.includes(semesterValue)) {
                    console.log(`  → FILTERED OUT (semester)`);
                    return false;
                }
            }
            
            console.log(`Room ${roomName} - PASSED all filters`);
        }
        
        // For faculty tab, filter by department/year/semester using data attributes
        if (isFacultyTable) {
            const rowDepts = $(row).attr('data-departments') || '';
            const rowYears = $(row).attr('data-years') || '';
            const rowSemesters = $(row).attr('data-semesters') || '';
            
            if (currentFilters.department) {
                const deptName = $('#filterDepartment option:selected').text().trim();
                // Also check column 2 for backwards compatibility
                if (!rowDepts || (!rowDepts.includes(deptName) && (!data[2] || !data[2].includes(deptName)))) {
                    return false;
                }
            }
            
            if (currentFilters.year) {
                if (!rowYears || !rowYears.includes(currentFilters.year)) {
                    return false;
                }
            }
            
            if (currentFilters.semester) {
                const semesterValue = currentFilters.semester;
                if (!rowSemesters || !rowSemesters.includes(semesterValue)) {
                    return false;
                }
            }
        }
        
        return true;
    }
);

function applyFilters() {
    currentFilters.department = document.getElementById('filterDepartment').value;
    currentFilters.year = document.getElementById('filterYear').value;
    currentFilters.semester = document.getElementById('filterSemester').value;
    currentFilters.search = document.getElementById('filterSearch').value;
    
    console.log('Applying filters:', currentFilters);
    
    // Redraw both tables if they exist
    if (roomsTable) {
        console.log('Redrawing rooms table');
        roomsTable.draw();
    }
    if (facultyTable) {
        console.log('Redrawing faculty table');
        facultyTable.draw();
    }
}

// Clear Filters button
document.getElementById('clearFilters').addEventListener('click', function() {
    document.getElementById('filterDepartment').value = '';
    document.getElementById('filterYear').value = '';
    document.getElementById('filterSemester').value = '';
    document.getElementById('filterSearch').value = '';
    
    currentFilters = { department: '', year: '', semester: '', search: '' };
    
    // Redraw both tables
    if (roomsTable) roomsTable.draw();
    if (facultyTable) facultyTable.draw();
});

// Apply filters on change (instant filtering - no page reload)
document.getElementById('filterDepartment').addEventListener('change', applyFilters);
document.getElementById('filterYear').addEventListener('change', applyFilters);
document.getElementById('filterSemester').addEventListener('change', applyFilters);

// Debounced search input
let searchTimeout;
document.getElementById('filterSearch').addEventListener('keyup', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(applyFilters, 300);
});

// Restore active tab from localStorage or default to rooms
document.addEventListener('DOMContentLoaded', function() {
    const activeTab = localStorage.getItem('activeHistoryTab') || 'rooms';
    showTab(activeTab);
    
    // Initialize DataTables after a short delay
    setTimeout(() => {
        initRoomsTable();
        initFacultyTable();
    }, 100);
});
</script>
{% endblock %}
